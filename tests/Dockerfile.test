FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    curl \
    git \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 复制requirements文件
COPY api-service/requirements.txt /app/requirements.txt

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 安装测试依赖
RUN pip install --no-cache-dir \
    pytest==7.4.3 \
    pytest-asyncio==0.21.1 \
    pytest-cov==4.1.0 \
    pytest-mock==3.12.0 \
    pytest-xdist==3.5.0 \
    pytest-html==3.2.0 \
    httpx==0.25.2 \
    requests==2.31.0

# 复制项目文件
COPY api-service/ /app/api-service/
COPY tests/ /app/tests/

# 设置环境变量
ENV PYTHONPATH=/app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# 创建测试结果目录
RUN mkdir -p /app/test-results /app/test-coverage

# 默认命令（会被docker-compose覆盖）
CMD ["pytest", "/app/tests/", "-v"]
